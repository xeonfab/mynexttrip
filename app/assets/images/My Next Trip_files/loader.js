"use strict";function _defineProperty(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}!function(e){function r(){var r=e.skyscanner=e.skyscanner||{},t=r.widgets=r.widgets||{};return t.renderCache=t.renderCache||{},t.requests=t.requests||{},{widgets:t}}function t(e,r,t){return r=r||"",t=t||{},t.v="d1bab3",e+r+"?"+Object.keys(t).filter(function(e){return e&&null!==t[e]&&void 0!==t[e]}).map(function(e){return encodeURIComponent(e)+"="+encodeURIComponent(t[e])}).join("&")}function n(e,r){return t("https://www.skyscanner.net/g/widget-server",e,r)}function a(e,r){return t("https://www.skyscanner.net/g/widget-server",e,r)}function i(r,t){d+=1,this.scope=t||h,this.xhr=e&&e.XMLHttpRequest,this.element=r,this.locale=this.element.dataset.locale||"en-GB",this.market=this.element.dataset.market||"any",this.currency=this.element.dataset.currency||"any",this.widgetType=this.element.dataset.skyscannerWidget,this.params={},this.xhrParams=[],this.errors=[],this.serverUrl="https://www.skyscanner.net/g/widget-server",this.widgetIndex=d,this.measurements={},this.size=0}function s(e){return e.document?window.location===window.parent.location?document.location.href:document.referrer:e.location?e.location.href:null}function o(r){if(e.document&&e.document.querySelectorAll){var t=e.document.querySelectorAll(r);return Array.prototype.slice.call(t)}}var d=0,c="https://www.skyscanner.net/g/widget-server/frontendMetrics",h=r(),l=/^\{(.+)\}$/,u=/^([^(]+)\(([^)]+)\)$/,m=i.prototype;m.removeXhr=function(e){delete this.scope.widgets.requests[e]},m.getXhr=function(r,t,n){if(!this.scope.widgets.requests[r]){var a=new this.xhr;a.addEventListener("loadend",this.removeXhr.bind(this,r)),a.open("GET",r,!0),t||a.setRequestHeader("Widget-Referrer",s(e)),n&&(a.withCredentials=!0),a.send(null),this.scope.widgets.requests[r]=a,a.onreadystatechange=function(){4===a.readyState&&200===a.status&&(this.size=a.responseText.length)}}return this.scope.widgets.requests[r]},m.addError=function(e,r){this.errors.push({message:e,error:r})},m.lookupLocation=function(e,r){for(var t in e)if(!e[t])return;return r&&(e.widgetType=r),this.getXhr(n("/v1.0/"+this.locale+"/"+this.market+"/"+this.currency+"/location",e))},m.unregisterXhrParam=function(e){this.xhrParams=this.xhrParams.filter(function(r){return r.request!==e})},m.handleXhrParamLoad=function(e,r){this.unregisterXhrParam(r),4!==r.readyState||200!==r.status?this.setParam(e,null):this.setParam(e,r.responseText),this.beginRender()},m.registerXhrParam=function(e,r){this.xhrParams.push({key:e,request:r}),r.addEventListener("load",this.handleXhrParamLoad.bind(this,e,r))},m.setSimpleParam=function(e,r){if(void 0===r)return void this.addError('Undefined parameter value for key "'+e+'"');this.params[e]=r},m.setComplexParams=function(e,r){var t=this,n=null;if("string"==typeof r)try{n=JSON.parse(r)}catch(e){this.addError("Error parsing JSON data: "+r)}else n=r;e.forEach(function(e){t.setSimpleParam(e.paramKey,n&&n[e.objectKey]||null)})},m.setParam=function(e,r){if(r instanceof this.xhr)this.registerXhrParam(e,r);else{var t=e.match(l);if(t){var n=t[1].split(",").map(function(e){return e.trim()}).map(function(e){var r=e.match(u);return r?{paramKey:r[1],objectKey:r[2]}:{paramKey:e,objectKey:e}});this.setComplexParams(n,r)}else this.setSimpleParam(e,r)}},m.parseParamString=function(e){var r={};return e.split(";").forEach(function(e){var t=e.split(":");e&&t.length>1&&(r[t[0]]=t[1])}),r},m.parseFixedParams=function(){var e=this,r=[];this.element.dataset.params&&(r=this.parseParamString(this.element.dataset.params)),Object.keys(r).forEach(function(t){e.setParam(t,r[t])})},m.parseScriptedParams=function(){var e=this,r=this.element,t=r.dataset.scriptParams;if(t)try{var n=JSON.parse(t);Object.keys(n).forEach(function(r){var t=n[r];if(r&&t)try{Array.isArray(t)&&(t=t.join("\n"));var a=function(){return eval("("+t+")")}.apply(e);e.setParam(r,a)}catch(t){e.addError('Error parsing scripted parameter "'+r+'"',t)}})}catch(e){this.addError("Error parsing data-script-parameters: "+t,e)}},m.parseLocationParams=function(){function e(e){return{HotelSearchWidget:"q",MultiVerticalWidget:["destination","q"],CarHireWidget:"destination"}[e]||"destination"}function r(e){return Array.isArray(e)?e:[e]}function t(e){return r(m.types[e])}function n(e){return r(m.attributes[e])}function a(e,r){var t=e+"-"+r,n=l.element.getAttribute("data-"+t);if(n)try{var a=function(){return eval("("+n+")")}.apply(l);if(void 0===a||"undefined"===a)throw"Undefined value";return l.element.removeAttribute("data-"+t),a}catch(e){console.warn("Failed to evaluate location "+t+" script: "+e)}}function i(e,r,t){return n(t).reduce(function(n,i){var s=a(r,i);return void 0!==s&&(e[t]=s),e},e)}function s(e,r){return Object.keys(m.attributes).reduce(function(e,t){return i(e,r,t)},e)}function o(e){var r=e.split(",");return 1===r.length?"{"+r[0]+"(name),"+r[0]+"Id(id)}":"{"+r.reduce(function(e,r){return e+"".concat(r,"(").concat(r,"Name), ").concat(r,"Id(").concat(r,"Id),")},"")+"}"}function d(e,r){var t=o(e),n=l.lookupLocation(r,l.widgetType);n&&l.setParam(t,n)}function c(e){var r=t(e).reduce(s,{});Object.keys(r).length>0&&d(e,r)}var h,l=this,u=e(l.widgetType),m={types:(h={},_defineProperty(h,u,["location","destination"]),_defineProperty(h,"origin","origin"),h),attributes:{name:["param","name"],latlon:"coords",phrase:"phrase",iataCode:"iata-code",geo:"geo-lookup"}};Object.keys(m.types).forEach(c)},m.parseAffiliateParams=function(){var e=this.element.dataset.affiliate;if(e){var r=JSON.stringify(this.parseParamString(e));this.setParam("tracking",r)}},m.mergeAttributesIntoParams=function(){var e=this,r=["skyscannerWidget","skyscannerWidgetLoading","locale","market","currency","params","affiliate"];Object.keys(this.element.dataset).filter(function(e){return-1===r.indexOf(e)}).forEach(function(r){e.params[r]=e.params[r]||e.element.dataset[r]})},m.beginRender=function(){if(!(this.xhrParams.length>0)){if(this.errors.length>0)return console.log("Error(s) occured while loading widget",this),void this.errors.forEach(function(e){console.log(e.message),e.error&&console.log(e.error)});this.mergeAttributesIntoParams();var e=n("/v1.0/"+this.locale+"/"+this.market+"/"+this.currency+"/widgets/"+this.widgetType,this.params);this.widgetMark="".concat(this.locale,"_").concat(this.market,"_").concat(this.currency,"_").concat(this.widgetType,"_").concat(this.widgetIndex);try{performance.mark("beginRender_".concat(this.widgetMark))}catch(e){console.error("Error in performance.mark beginRender:",e)}if(void 0!==this.scope.widgets.renderCache[e]){var r=this.scope.widgets.renderCache[e];this.renderedFromCache=!0,this.render(r.code,r.personalise)}else{var t=this.getXhr(e);t.addEventListener("load",this.handleRenderLoad.bind(this,e,t)),t.addEventListener("error",this.handleRenderLoadError.bind(this,e,t))}}},m.handleRenderLoad=function(e,r){if(4===r.readyState){if(200!==r.status)return void this.handleRenderLoadError(e,r);var t=r.responseText,n="true"===r.getResponseHeader("Widget-Personalisation-Enabled");this.scope.widgets.renderCache[e]={code:t,personalise:n};try{performance.mark("handleRenderLoad_".concat(this.widgetMark)),performance.measure("beginRender_handleRenderLoad_".concat(this.widgetMark),"beginRender_".concat(this.widgetMark),"handleRenderLoad_".concat(this.widgetMark)),this.measurements.load_widget_code_time=performance.getEntriesByName("beginRender_handleRenderLoad_".concat(this.widgetMark))[0].duration,this.size=r.size}catch(e){console.error("Error in handleRenderLoad performance measure: ",e)}this.render(t,n)}},m.dispatchEvent=function(r,t){if(e.CustomEvent){var n=null;"function"==typeof e.CustomEvent?n=new e.CustomEvent(r,t):e.document&&e.document.createEvent&&(n=e.document.createEvent("CustomEvent"),n.initCustomEvent(r,!1,!1,t&&t.detail||{})),n&&this.element.dispatchEvent(n)}},m.logOperationalMetrics=function(r){var t=new this.xhr;t.addEventListener("loadend",this.removeXhr.bind(this,c)),t.open("POST",c,!0),t.setRequestHeader("Widget-Referrer",s(e)),t.withCredentials=!1,t.setRequestHeader("Content-Type","application/json");var n={measurements:this.measurements,widgetProperties:{locale:this.locale,market:this.market,currency:this.currency,widgetType:this.widgetType},size:this.size,eventType:r};t.send(JSON.stringify(n))},m.render=function(e,r){var t=this;try{(function(__widget){eval(e)}).call(this,this),this.replaceScriptNodes(),r&&this.personalise(),Object.keys(t.element.dataset).forEach(function(e){delete t.element.dataset[e]}),t.element.dataset.skyscannerWidgetLoaded=!0;try{performance.mark("render_".concat(this.widgetMark)),performance.measure("handleRenderLoad_render_".concat(this.widgetMark),"handleRenderLoad_".concat(this.widgetMark),"render_".concat(this.widgetMark)),this.measurements.render_widget_code_time=performance.getEntriesByName("handleRenderLoad_render_".concat(this.widgetMark))[0].duration}catch(e){console.error("Error in render performance measure: ",e)}this.dispatchEvent("skyscanner-widget-load",{detail:{widget:t}})}catch(e){t.element.dataset.skyscannerWidgetError=!0,console.error("Error rendering widget:",e);try{performance.mark("render_error_".concat(this.widgetMark)),performance.measure("handleRenderLoad_renderError_".concat(this.widgetMark),"handleRenderLoad_".concat(this.widgetMark),"render_error_".concat(this.widgetMark)),this.measurements.render_widget_code_time_err=performance.getEntriesByName("handleRenderLoad_renderError_".concat(this.widgetMark))[0].duration}catch(e){console.error("Error in render_error performance measurement:",e)}this.dispatchEvent("skyscanner-widget-render-error",{detail:{widget:t,error:e}})}},m.handleRenderLoadError=function(e,r){this.element.dataset.skyscannerWidgetError=!0,console.error("Error rendering widget:",r);try{performance.mark("handleRenderLoadError_".concat(this.widgetMark)),performance.measure("beginRender_handleRenderLoadError_".concat(this.widgetMark),"beginRender_".concat(this.widgetMark),"handleRenderLoadError_".concat(this.widgetMark)),this.measurements.load_widget_code_time_err=performance.getEntriesByName("beginRender_handleRenderLoadError_".concat(this.widgetMark))[0].duration}catch(e){console.error("Error in render_error performance measurement:",e)}this.dispatchEvent("skyscanner-widget-load-error",{detail:{widget:this,status:r.status,error:r.responseText}})},m.personalise=function(){var e=this,r={};Object.keys(e.params).forEach(function(t){r[t]=e.params[t]}),r.locale=e.locale,r.market=e.market,r.currency=e.currency,r.widgetType=e.widgetType;var t=a("/personalise",r),n=this.getXhr(t,!0,!0);n.addEventListener("load",this.handlePersonalisationData.bind(this,n))},m.handlePersonalisationData=function(e){if(4===e.readyState&&200===e.status){var r=JSON.parse(e.responseText);r.personalise&&(void 0!==r.message&&(this.element.querySelector(".skyscanner-widget-text").innerHTML=r.message),void 0!==r.referralUrl&&(this.element.querySelector("a").href=r.referralUrl))}},m.replaceScriptNodes=function(){var r=this.element.querySelectorAll("script");Array.prototype.forEach.call(r,function(r){if("SCRIPT"===r.tagName){var t=e.document.createElement("script");t.text=r.innerHTML,Array.prototype.forEach.call(r.attributes,function(e){"replace"!==e.name&&t.setAttribute(e.name,e.value)}),r.parentNode.replaceChild(t,r)}})},h.widgets.load=function(e){e=e||o;var r=e("[data-skyscanner-widget]");r&&r.forEach(function(e){if(!(e.dataset.skyscannerWidgetLoading||e.dataset.skyscannerWidgetLoaded||e.dataset.skyscannerWidgetError)){e.dataset.skyscannerWidgetLoading=!0;var r=new i(e);r.parseFixedParams(),r.parseScriptedParams(),r.parseLocationParams(),r.parseAffiliateParams(),r.beginRender(),r.element.addEventListener("skyscanner-widget-load",function(){r.logOperationalMetrics("widget_load")}.bind(r)),r.element.addEventListener("skyscanner-widget-load-error",function(){r.logOperationalMetrics("widget_load_error")}.bind(r)),r.element.addEventListener("skyscanner-widget-render-error",function(){r.logOperationalMetrics("widget_render_error")}.bind(r))}})};var f=function(e){"true"===e&&h.widgets.load()};f("true"),"undefined"!=typeof module&&module.exports&&(module.exports={getWidgetUrl:n,WidgetElement:i,globals:h})}("undefined"==typeof window?global:window);